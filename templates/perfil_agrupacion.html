<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Agrupación — Carnaval de Cádiz</title>
    <meta name="description" content="Perfil de agrupación del Carnaval de Cádiz: historia, autores, obras y análisis poético.">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/perfil.css">
</head>
<body>

<header class="main-header perfil-header">
    <div class="header-content">
        <a href="/" class="header-back">&larr; Archivo del Carnaval</a>
        <h1 class="logo" id="headerNombre">Cargando...</h1>
        <p class="subtitle" id="headerSubtitle"></p>
    </div>
</header>

<div class="perfil-layout" id="perfilLayout" style="display:none">

    <!-- COLUMNA IZQUIERDA: FICHA -->
    <aside class="perfil-aside">
        <div class="ficha-card">
            <div class="ficha-avatar agrupacion-avatar" id="fichaAvatar"></div>
            <h2 class="ficha-nombre" id="fichaNombre"></h2>
            <div class="ficha-tipo" id="fichaTipo">Agrupación del Carnaval de Cádiz</div>

            <div class="ficha-stats">
                <div class="ficha-stat">
                    <span class="ficha-stat-num" id="fTotal">--</span>
                    <span class="ficha-stat-lbl">Letras</span>
                </div>
                <div class="ficha-stat">
                    <span class="ficha-stat-num" id="fAutores">--</span>
                    <span class="ficha-stat-lbl">Autores</span>
                </div>
                <div class="ficha-stat">
                    <span class="ficha-stat-num" id="fAnios">--</span>
                    <span class="ficha-stat-lbl">Años activos</span>
                </div>
            </div>

            <div class="ficha-meta">
                <div class="ficha-meta-row">
                    <span class="ficha-meta-lbl">Periodo</span>
                    <span class="ficha-meta-val" id="fPeriodo">--</span>
                </div>
                <div class="ficha-meta-row">
                    <span class="ficha-meta-lbl">Modalidad</span>
                    <span class="ficha-meta-val" id="fModalidades">--</span>
                </div>
                <div class="ficha-meta-row">
                    <span class="ficha-meta-lbl">Longitud media</span>
                    <span class="ficha-meta-val" id="fLongitud">--</span>
                </div>
                <div class="ficha-meta-row">
                    <span class="ficha-meta-lbl">Calidad media</span>
                    <span class="ficha-meta-val" id="fCalidad">--</span>
                </div>
            </div>

            <!-- Score poético -->
            <div class="ficha-score" id="fichaScore" style="display:none">
                <div class="score-poetico-big" id="scoreValor">--</div>
                <div class="score-poetico-lbl">Score poético medio</div>
                <div class="score-sub" id="scoreSub"></div>
            </div>
        </div>

        <!-- AUTORES -->
        <div class="ficha-card" id="cardAutores">
            <h3 class="ficha-card-title">Autores</h3>
            <div id="listaAutores"></div>
        </div>
    </aside>

    <!-- COLUMNA DERECHA: CONTENIDO -->
    <main class="perfil-main">

        <!-- VERSOS ICÓNICOS (si hay) -->
        <section class="perfil-section versos-hero" id="sectionVersos" style="display:none">
            <h2 class="section-title">Versos de referencia</h2>
            <div id="versosContainer" class="versos-iconicos"></div>
        </section>

        <!-- ACTIVIDAD TEMPORAL -->
        <section class="perfil-section">
            <h2 class="section-title">Historia y actividad por año</h2>
            <div id="actividadBar" class="chart-bars actividad-bars"></div>
        </section>

        <!-- ANÁLISIS POÉTICO -->
        <section class="perfil-section" id="sectionPoetica" style="display:none">
            <h2 class="section-title">Análisis Poético del Estilo</h2>
            <div class="poetica-grid">
                <div class="poetica-mini-card">
                    <h4>Metros más usados</h4>
                    <div id="pMetros" class="chart-bars"></div>
                </div>
                <div class="poetica-mini-card">
                    <h4>Tipo de rima</h4>
                    <div id="pRimas" class="chart-bars"></div>
                </div>
                <div class="poetica-mini-card">
                    <h4>Figuras retóricas</h4>
                    <div id="pFiguras" class="chart-bars"></div>
                </div>
                <div class="poetica-mini-card">
                    <h4>Tipos de pieza</h4>
                    <div id="pTipos" class="chart-bars"></div>
                </div>
            </div>

            <div id="sectionLexico" style="display:none">
                <h3 class="section-subtitle">Léxico gaditano y carnavalesco</h3>
                <div id="pLexico" class="nube-container" style="min-height:100px"></div>
            </div>

            <div id="sectionTopLetras" style="display:none">
                <h3 class="section-subtitle">Letras más destacadas poéticamente</h3>
                <div id="pTopLetras" class="letras-grid"></div>
            </div>
        </section>

        <!-- TIPOS DE PIEZA -->
        <section class="perfil-section">
            <h2 class="section-title">Tipos de pieza</h2>
            <div id="tiposPiezaContainer" class="tipos-pieza-grid"></div>
        </section>

        <!-- LETRAS COMPLETAS -->
        <section class="perfil-section">
            <h2 class="section-title">Letras
                <span class="section-count" id="obrasCount"></span>
            </h2>
            <div class="obras-filtros">
                <select id="obrasFiltroAnio" onchange="filtrarObras()">
                    <option value="">Todos los años</option>
                </select>
                <select id="obrasFiltroTipo" onchange="filtrarObras()">
                    <option value="">Todos los tipos</option>
                </select>
                <input type="text" id="obrasBuscar" placeholder="Buscar en letras..." oninput="filtrarObras()">
            </div>
            <div id="obrasGrid" class="letras-grid"></div>
        </section>

    </main>
</div>

<div id="perfilError" style="display:none" class="perfil-error">
    <p>No se encontró la agrupación solicitada.</p>
    <a href="/" class="btn-primary">Volver al archivo</a>
</div>

<!-- MODAL DETALLE LETRA -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="cerrarModal()">&times;</button>
        <div id="detalle"></div>
    </div>
</div>

<!-- MODAL ANÁLISIS POÉTICO -->
<div class="modal-overlay" id="modalPoetaOverlay" onclick="cerrarModalPoeta()">
    <div class="modal-content modal-poetico" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="cerrarModalPoeta()">&times;</button>
        <div id="detallePoeta"></div>
    </div>
</div>

<footer class="main-footer">
    <p class="footer-links">
        <a href="/">Archivo</a> &middot;
        <a href="/admin">Admin</a> &middot;
        <a href="/api/agrupaciones">API Agrupaciones</a>
    </p>
</footer>

<script>
const nombreAgrupacion = decodeURIComponent(location.pathname.split("/agrupacion/")[1] || "");
let _obrasData = [];

document.addEventListener("DOMContentLoaded", () => {
    if (!nombreAgrupacion) { mostrarError(); return; }
    cargarPerfil();
    document.addEventListener("keydown", e => {
        if (e.key === "Escape") { cerrarModal(); cerrarModalPoeta(); }
    });
});

function mostrarError() {
    document.getElementById("perfilError").style.display = "flex";
}

function cargarPerfil() {
    fetch(`/api/agrupacion/${encodeURIComponent(nombreAgrupacion)}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) { mostrarError(); return; }
            renderPerfil(data);
        })
        .catch(mostrarError);
}

function renderPerfil(d) {
    document.title = `${d.agrupacion} — Archivo Carnaval Cádiz`;
    document.getElementById("pageTitle").textContent = `${d.agrupacion} — Carnaval de Cádiz`;
    document.getElementById("headerNombre").textContent = d.agrupacion;
    document.getElementById("headerSubtitle").textContent =
        `${d.modalidades || "Agrupación"} · ${d.total_letras} letras · ${d.periodo}`;

    document.getElementById("fichaNombre").textContent = d.agrupacion;
    document.getElementById("fichaAvatar").textContent = iniciales(d.agrupacion);
    document.getElementById("fichaTipo").textContent = d.modalidades || "Agrupación del Carnaval";

    document.getElementById("fTotal").textContent = d.total_letras;
    document.getElementById("fAutores").textContent = d.total_autores;
    document.getElementById("fAnios").textContent = d.anios_activos;
    document.getElementById("fPeriodo").textContent = d.periodo;
    document.getElementById("fModalidades").textContent = d.modalidades || "—";
    document.getElementById("fLongitud").textContent = d.longitud_media
        ? d.longitud_media.toLocaleString("es-ES") + " chars" : "—";
    document.getElementById("fCalidad").textContent = d.calidad_media
        ? d.calidad_media + "/100" : "—";

    // Score
    if (d.score_poetico_medio > 0) {
        const sc = document.getElementById("fichaScore");
        sc.style.display = "block";
        const val = document.getElementById("scoreValor");
        val.textContent = d.score_poetico_medio;
        const c = d.score_poetico_medio >= 70 ? "var(--success)" :
                  d.score_poetico_medio >= 40 ? "var(--gold)" : "var(--text-muted)";
        val.style.color = c;
        const metro = (d.metros_frecuentes || [])[0];
        document.getElementById("scoreSub").textContent =
            metro ? `Metro favorito: ${metro.metro}` : "";
    }

    // Autores
    renderAutores(d.autores_detalle || []);

    // Versos icónicos
    if ((d.versos_icono || []).length > 0) {
        document.getElementById("sectionVersos").style.display = "block";
        renderVersosIconicos(d.versos_icono);
    }

    // Actividad anual
    renderActividadAnual(d.actividad_anual || []);

    // Poética
    const hayPoetica = (d.metros_frecuentes || []).length > 0;
    if (hayPoetica) {
        document.getElementById("sectionPoetica").style.display = "block";
        renderBarChart("pMetros", (d.metros_frecuentes || []).map(x => ({label: x.metro, value: x.cnt})));
        renderBarChart("pRimas", (d.tipos_rima || []).map(x => ({label: x.tipo, value: x.cnt})));
        renderBarChart("pFiguras", (d.figuras_frecuentes || []).map(x => ({label: x.figura, value: x.cnt})));
        renderBarChart("pTipos", (d.tipos_pieza || []).map(x => ({label: x.tipo, value: x.cnt})));

        if ((d.lexico_gaditano || []).length > 0) {
            document.getElementById("sectionLexico").style.display = "block";
            renderMiniNube("pLexico", d.lexico_gaditano, "cnt");
        }
        if ((d.top_letras_poeticas || []).length > 0) {
            document.getElementById("sectionTopLetras").style.display = "block";
            renderTopLetras("pTopLetras", d.top_letras_poeticas);
        }
    }

    // Tipos de pieza
    renderTiposPieza(d.tipos_pieza || []);

    // Obras
    _obrasData = d.obras || [];
    poblarFiltrosObras(_obrasData);
    renderObras(_obrasData);

    document.getElementById("perfilLayout").style.display = "grid";
}

function iniciales(nombre) {
    return nombre.trim().split(/\s+/).map(p => p[0]).join("").toUpperCase().slice(0, 2);
}

function renderAutores(lista) {
    const cont = document.getElementById("listaAutores");
    if (!lista.length) { cont.innerHTML = '<span class="text-muted">Sin datos de autor</span>'; return; }
    cont.innerHTML = lista.map(a => `
        <a class="agrupacion-item" href="/autor/${encodeURIComponent(a.autor)}">
            <span class="agrupacion-nombre">${escH(a.autor)}</span>
            <span class="agrupacion-meta">${a.cnt} obras · ${a.desde || '?'} – ${a.hasta || '?'}</span>
        </a>
    `).join("");
}

function renderVersosIconicos(versos) {
    const cont = document.getElementById("versosContainer");
    cont.innerHTML = versos.map(v => `
        <blockquote class="verso-iconico">
            <p>${escH(v.verso)}</p>
            <footer>— <em>${escH(v.titulo)}</em>${v.anio ? ` (${escH(String(v.anio))})` : ""}</footer>
        </blockquote>
    `).join("");
}

function renderActividadAnual(lista) {
    const cont = document.getElementById("actividadBar");
    if (!lista.length) { cont.innerHTML = '<span class="text-muted">Sin datos</span>'; return; }
    const max = Math.max(...lista.map(d => d.cnt));
    cont.innerHTML = lista.map(d => {
        const pct = (d.cnt / max * 100).toFixed(1);
        const sc = d.score_medio;
        const c = sc >= 70 ? "var(--success)" : sc >= 40 ? "var(--gold)" : "var(--accent)";
        return `
            <div class="bar-row actividad-row">
                <span class="bar-label">${escH(String(d.anio))}</span>
                <div class="bar-track">
                    <div class="bar-fill" style="width:${pct}%;background:${c}"></div>
                </div>
                <span class="bar-value">${d.cnt}</span>
                ${d.tipos ? `<span class="bar-score" style="color:var(--text-muted)">${escH(d.tipos)}</span>` : ""}
            </div>`;
    }).join("");
}

function renderTiposPieza(lista) {
    const cont = document.getElementById("tiposPiezaContainer");
    if (!lista.length) { cont.innerHTML = '<span class="text-muted">Sin datos</span>'; return; }
    const total = lista.reduce((s, x) => s + x.cnt, 0);
    cont.innerHTML = lista.map(t => {
        const pct = Math.round(t.cnt / total * 100);
        return `
            <div class="tipo-pieza-item">
                <div class="tipo-pieza-label">${escH(t.tipo)}</div>
                <div class="tipo-pieza-bar"><div class="tipo-pieza-fill" style="width:${pct}%"></div></div>
                <div class="tipo-pieza-meta">${t.cnt} <span class="text-muted">(${pct}%)</span></div>
            </div>`;
    }).join("");
}

function renderTopLetras(containerId, lista) {
    const cont = document.getElementById(containerId);
    cont.innerHTML = lista.map(l => `
        <div class="letra-card poetica-card" onclick="cargarDetalle(${l.id})">
            <div class="titulo">${escH(l.titulo)}</div>
            <div class="meta">
                ${l.anio ? `<span class="tag anio">${escH(String(l.anio))}</span>` : ""}
                ${l.tipo_pieza ? `<span class="tag tipo">${escH(l.tipo_pieza)}</span>` : ""}
                ${l.autor ? `<span class="tag autor">${escH(l.autor)}</span>` : ""}
                ${l.nombre_metro ? `<span class="tag">${escH(l.nombre_metro)}</span>` : ""}
                ${l.score_poetico ? `<span class="tag score-tag">Score: ${l.score_poetico}/100</span>` : ""}
            </div>
        </div>`).join("");
}

function poblarFiltrosObras(obras) {
    const anios = [...new Set(obras.map(o => o.anio).filter(Boolean))].sort().reverse();
    const tipos = [...new Set(obras.map(o => o.tipo_pieza).filter(Boolean))].sort();

    const selAnio = document.getElementById("obrasFiltroAnio");
    anios.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a; opt.textContent = a; selAnio.appendChild(opt);
    });
    const selTipo = document.getElementById("obrasFiltroTipo");
    tipos.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t; opt.textContent = t; selTipo.appendChild(opt);
    });
    document.getElementById("obrasCount").textContent = `(${obras.length})`;
}

function filtrarObras() {
    const anio = document.getElementById("obrasFiltroAnio").value;
    const tipo = document.getElementById("obrasFiltroTipo").value;
    const q = document.getElementById("obrasBuscar").value.toLowerCase();
    const filtradas = _obrasData.filter(o => {
        if (anio && o.anio !== anio) return false;
        if (tipo && o.tipo_pieza !== tipo) return false;
        if (q && !o.titulo.toLowerCase().includes(q)) return false;
        return true;
    });
    renderObras(filtradas);
}

function renderObras(obras) {
    const cont = document.getElementById("obrasGrid");
    if (!obras.length) {
        cont.innerHTML = '<div class="empty-state">No hay letras con esos filtros</div>';
        return;
    }
    cont.innerHTML = obras.map(o => {
        const sc = o.score_poetico;
        const scC = sc >= 70 ? "var(--success)" : sc >= 40 ? "var(--gold)" : "";
        return `
        <div class="letra-card" onclick="cargarDetalle(${o.id})">
            <div class="titulo">${escH(o.titulo)}</div>
            <div class="meta">
                ${o.anio ? `<span class="tag anio">${escH(String(o.anio))}</span>` : ""}
                ${o.tipo_pieza ? `<span class="tag tipo">${escH(o.tipo_pieza)}</span>` : ""}
                ${o.autor ? `<span class="tag autor">${escH(o.autor)}</span>` : ""}
                ${sc > 0 ? `<span class="tag" style="color:${scC};border-color:${scC}">♟ ${sc}</span>` : ""}
            </div>
        </div>`;
    }).join("");
}

// UTILS
function escH(t) {
    if (!t) return "";
    const d = document.createElement("div"); d.textContent = t; return d.innerHTML;
}
function renderBarChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container || !data || !data.length) return;
    container.innerHTML = "";
    const maxVal = Math.max(...data.map(d => d.value));
    data.forEach(d => {
        const pct = (d.value / maxVal * 100).toFixed(1);
        const row = document.createElement("div");
        row.className = "bar-row";
        row.innerHTML = `<span class="bar-label">${escH(String(d.label || "N/A"))}</span>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
            <span class="bar-value">${d.value}</span>`;
        container.appendChild(row);
    });
}
function renderMiniNube(containerId, items, freqKey) {
    const cont = document.getElementById(containerId);
    if (!cont || !items.length) return;
    cont.innerHTML = "";
    const maxF = Math.max(...items.map(d => d[freqKey]));
    const minF = Math.min(...items.map(d => d[freqKey]));
    const cols = ["var(--accent)","var(--gold)","var(--accent-light)","var(--success)","var(--text-secondary)"];
    [...items].sort(() => Math.random() - 0.5).forEach(item => {
        const ratio = (item[freqKey] - minF) / (maxF - minF || 1);
        const span = document.createElement("span");
        span.className = "nube-word";
        span.textContent = item.palabra || "?";
        span.style.fontSize = (0.7 + ratio * 1.3) + "rem";
        span.style.color = cols[Math.floor((1 - ratio) * (cols.length - 1))];
        span.title = `${item.palabra}: ${item[freqKey]}`;
        cont.appendChild(span);
    });
}

// MODAL LETRA
function cargarDetalle(id) {
    fetch("/api/letra/" + id).then(r => r.json()).then(data => {
        const det = document.getElementById("detalle");
        let m = "";
        if (data.anio) m += `<span class="tag anio">${escH(String(data.anio))}</span>`;
        if (data.modalidad) m += `<span class="tag modalidad">${escH(data.modalidad)}</span>`;
        if (data.tipo_pieza) m += `<span class="tag tipo">${escH(data.tipo_pieza)}</span>`;
        if (data.autor) m += `<span class="tag autor">${escH(data.autor)}</span>`;

        let sH = "";
        if (data.score_poetico > 0) {
            const c = data.score_poetico >= 70 ? "var(--success)" : data.score_poetico >= 40 ? "var(--gold)" : "var(--text-muted)";
            sH = `<div class="detalle-poetica-tags"><span class="tag" style="color:${c};border-color:${c}">Score poético: ${data.score_poetico}/100</span>
                ${data.nombre_metro ? `<span class="tag">${escH(data.nombre_metro)}</span>` : ""}
                ${data.tipo_rima ? `<span class="tag">Rima ${escH(data.tipo_rima)}</span>` : ""}</div>`;
        }
        let vH = "";
        if (data.versos_destacados) {
            try {
                const vv = JSON.parse(data.versos_destacados);
                if (vv && vv.length) vH = `<div class="detalle-versos-destacados"><span class="versos-label">Versos destacados:</span>
                    ${vv.map(v => `<blockquote class="verso-destacado">${escH(v)}</blockquote>`).join("")}</div>`;
            } catch(e) {}
        }
        det.innerHTML = `<h2>${escH(data.titulo)}</h2><div class="detalle-meta">${m}</div>${sH}${vH}
            <div class="detalle-texto">${escH(data.contenido || "Sin contenido")}</div>
            ${data.url ? `<div class="detalle-fuente">Fuente: <a href="${escH(data.url)}" target="_blank" rel="noopener">${escH(data.fuente || "Original")}</a></div>` : ""}
            <div class="detalle-acciones"><button class="btn-poetico" onclick="abrirAnalisisPoeta(${data.id})">&#9997; Análisis poético</button></div>`;
        document.getElementById("modalOverlay").classList.add("open");
    });
}
function cerrarModal() { document.getElementById("modalOverlay").classList.remove("open"); }

// MODAL ANÁLISIS POÉTICO (mismo que perfil_autor)
function abrirAnalisisPoeta(id) {
    const overlay = document.getElementById("modalPoetaOverlay");
    const det = document.getElementById("detallePoeta");
    det.innerHTML = '<div class="loading">Analizando...</div>';
    overlay.classList.add("open");
    fetch(`/api/analisis_poetico/${id}`).then(r => r.json()).then(data => {
        if (data.error) { det.innerHTML = `<div class="empty-state">${escH(data.error)}</div>`; return; }
        renderAnalisisPoeta(det, data);
    }).catch(() => { det.innerHTML = '<div class="empty-state">Error al analizar</div>'; });
}
function cerrarModalPoeta() { document.getElementById("modalPoetaOverlay").classList.remove("open"); }

function renderAnalisisPoeta(cont, d) {
    const m = d.metrica || {}, r = d.rima || {}, v = d.vocabulario || {};
    const fig = d.figuras_retoricas || [], vs = d.versos_destacados || [];
    const score = d.score_poetico || 0;
    const scC = score >= 70 ? "var(--success)" : score >= 40 ? "var(--gold)" : "var(--text-muted)";
    const figH = fig.length ? fig.map(f => {
        const eH = (f.ejemplos||[]).map(e => e.versos ? `<blockquote class="figura-ejemplo">${escH(e.versos.join(" / "))}</blockquote>` : "").join("");
        return `<div class="figura-item"><strong>${escH(f.figura)}</strong>${f.count !== undefined ? ` <span class="figura-count">(${f.count})</span>` : ""}${f.palabras ? ` — <em>${f.palabras.map(p=>escH(p.palabra)).join(", ")}</em>` : ""}${eH}</div>`;
    }).join("") : '<span class="text-muted">No detectadas</span>';
    const vsH = vs.length ? vs.map(vv => `<blockquote class="verso-destacado">${escH(vv)}</blockquote>`).join("") : '<span class="text-muted">No disponibles</span>';
    const distH = Object.entries(m.distribucion||{}).length ? Object.entries(m.distribucion).map(([k,c])=>`<span class="tag">${escH(k)}: ${c}</span>`).join(" ") : "—";
    const estH = (r.estrofas||[]).slice(0,6).map(e=>`<div class="estrofa-row"><span class="estrofa-esquema">${escH(e.esquema||"—")}</span><span class="estrofa-info">${e.n_versos} versos · rima ${escH(e.tipo_rima||"?")}${e.forma_estrofica?" · "+escH(e.forma_estrofica):""}</span></div>`).join("") || "—";
    const pkH = (v.palabras_clave||[]).slice(0,12).map(p=>`<span class="tag">${escH(p.palabra)}</span>`).join(" ");
    cont.innerHTML = `<div class="analisis-poetico">
        <div class="analisis-header"><h2>Análisis Poético</h2>
            <div class="score-circle" style="border-color:${scC};color:${scC}"><span class="score-num">${score}</span><span class="score-label">/ 100</span></div></div>
        <div class="analisis-grid">
            <div class="analisis-card"><h4>Métrica</h4>
                <div class="analisis-row"><span>Metro dominante</span><strong>${escH(m.nombre_metro||"libre")}</strong></div>
                <div class="analisis-row"><span>Sílabas</span><strong>${m.metro_dominante||"—"}</strong></div>
                <div class="analisis-row"><span>Coherencia</span><strong>${m.coherencia_pct||0}%</strong></div>
                <div class="analisis-row"><span>Distribución</span><div>${distH}</div></div>
                <div class="analisis-row"><span>Estrofas</span><strong>${d.n_estrofas}</strong></div>
                <div class="analisis-row"><span>Versos</span><strong>${d.n_versos}</strong></div></div>
            <div class="analisis-card"><h4>Rima</h4>
                <div class="analisis-row"><span>Tipo</span><strong>${escH(r.tipo_rima||"libre")}</strong></div>
                <div class="analisis-row"><span>Esquema</span><strong class="esquema-badge">${escH(r.esquema_predominante||"—")}</strong></div>
                <div class="estrofas-lista">${estH}</div></div>
            <div class="analisis-card"><h4>Vocabulario</h4>
                <div class="analisis-row"><span>Total palabras</span><strong>${v.total_palabras||0}</strong></div>
                <div class="analisis-row"><span>Único</span><strong>${v.vocabulario_unico||0}</strong></div>
                <div class="analisis-row"><span>Densidad léxica</span><strong>${v.densidad_lexica||0}%</strong></div>
                <div class="analisis-row palabras-clave-row"><span>Palabras clave</span><div>${pkH||"—"}</div></div></div>
            <div class="analisis-card"><h4>Figuras Retóricas</h4>${figH}</div>
        </div>
        <div class="analisis-card analisis-full"><h4>Versos Destacados</h4>${vsH}</div>
    </div>`;
}
</script>
</body>
</html>
