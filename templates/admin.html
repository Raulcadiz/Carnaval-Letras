<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Archivo Carnaval</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .admin-layout { max-width: 1000px; margin: 0 auto; padding: 1.5rem; }
        .admin-header { text-align: center; margin-bottom: 2rem; }
        .admin-header h1 { font-size: 1.6rem; margin-bottom: 0.3rem; }
        .admin-header a { color: var(--accent); text-decoration: none; font-size: 0.85rem; }

        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }

        .admin-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
        }
        .admin-card h2 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        .admin-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .admin-card .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }

        .admin-card select,
        .admin-card input {
            padding: 0.5rem 0.7rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .result-box {
            margin-top: 1rem;
            padding: 0.8rem;
            background: var(--bg-hover);
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-height: 40px;
            white-space: pre-line;
        }
        .result-box.success { border-left: 3px solid var(--success); }
        .result-box.working { border-left: 3px solid var(--warning); color: var(--warning); }

        .admin-stats { margin-bottom: 1.5rem; }
        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        .admin-stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.8rem;
            text-align: center;
        }
        .admin-stat .val { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
        .admin-stat .lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
    </style>
</head>
<body>

<div class="admin-layout">
    <div class="admin-header">
        <h1>Panel de Administracion</h1>
        <a href="/">&larr; Volver al archivo</a>
    </div>

    <!-- STATS RAPIDAS -->
    <div class="admin-stats">
        <div class="admin-stats-grid" id="adminStats">
            <div class="admin-stat"><span class="val" id="aTotal">--</span><span class="lbl">Total letras</span></div>
            <div class="admin-stat"><span class="val" id="aVerificadas">--</span><span class="lbl">Verificadas</span></div>
            <div class="admin-stat"><span class="val" id="aCalidad">--</span><span class="lbl">Calidad media</span></div>
            <div class="admin-stat"><span class="val" id="aAños">--</span><span class="lbl">A&ntilde;os</span></div>
            <div class="admin-stat"><span class="val" id="aModalidades">--</span><span class="lbl">Modalidades</span></div>
        </div>
    </div>

    <!-- FUENTES -->
    <div class="admin-stats" style="margin-top:1rem;">
        <h3 style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;">Letras por fuente</h3>
        <div id="fuentesStats" class="admin-stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
            <div class="admin-stat"><span class="val">--</span><span class="lbl">Cargando...</span></div>
        </div>
    </div>

    <!-- GRID ACCIONES -->
    <div class="admin-grid">

        <!-- SCRAPER ORIGINAL -->
        <div class="admin-card">
            <h2>Scraper - Letras Desde el Paraiso</h2>
            <p>Blog fuente original. Recoge nuevas letras por paginaci&oacute;n.</p>
            <div class="actions">
                <input type="number" id="maxPaginas" placeholder="Max paginas" min="1" max="100" style="width:120px">
                <button class="btn-primary" onclick="ejecutarScraper()">Ejecutar</button>
            </div>
            <div class="result-box" id="resScraper">Listo para ejecutar</div>
        </div>

        <!-- SCRAPER LETRASDECARNAVAL -->
        <div class="admin-card">
            <h2>Scraper - LetrasDeCarnaval.com</h2>
            <p>~15.000 letras. Descarga solo las nuevas autom&aacute;ticamente. Puedes parar y continuar cuando quieras.</p>
            <div class="actions">
                <button class="btn-primary" id="btnLdcIniciar" onclick="ldcIniciar()">Escanear nuevas</button>
                <button class="btn-secondary" id="btnLdcDetener" onclick="ldcDetener()" style="display:none">Detener</button>
            </div>
            <div id="ldcProgress" style="margin-top:0.8rem;display:none;">
                <div style="background:var(--bg-hover);border-radius:4px;height:22px;overflow:hidden;margin-bottom:0.5rem;">
                    <div id="ldcBar" style="height:100%;background:var(--accent);width:0%;transition:width 0.5s;border-radius:4px;display:flex;align-items:center;justify-content:center;">
                        <span id="ldcPct" style="font-size:0.7rem;font-weight:700;color:#fff;"></span>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.3rem;text-align:center;font-size:0.75rem;margin-bottom:0.5rem;">
                    <span style="color:var(--success);">+<b id="ldcNuevas">0</b> nuevas</span>
                    <span style="color:var(--text-muted);"><b id="ldcDup">0</b> duplicadas</span>
                    <span style="color:var(--warning);"><b id="ldcErr">0</b> errores</span>
                </div>
            </div>
            <div class="result-box" id="resScraperLDC">Listo para ejecutar</div>
        </div>

        <!-- IMPORTADOR HUGGINGFACE -->
        <div class="admin-card">
            <h2>Importar - HuggingFace Dataset</h2>
            <p>Dataset abierto CC BY-SA 4.0. ~1.184 letras con autor y metadata verificada.</p>
            <div class="actions">
                <label style="font-size:0.8rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.3rem;">
                    <input type="checkbox" id="hfSoloAccurate"> Solo accurate
                </label>
                <button class="btn-primary" onclick="ejecutarHuggingFace()">Importar</button>
            </div>
            <div class="result-box" id="resHuggingFace">Listo para importar</div>
        </div>

        <!-- ENRIQUECER -->
        <div class="admin-card">
            <h2>Enriquecer Metadata</h2>
            <p>Extrae a&ntilde;o, modalidad, tipo de pieza y agrupacion de todos los titulos. Limpia textos y calcula calidad.</p>
            <div class="actions">
                <button class="btn-primary" onclick="enriquecer()">Enriquecer Todo</button>
            </div>
            <div class="result-box" id="resEnriquecer">Listo</div>
        </div>

        <!-- DEDUPLICACION -->
        <div class="admin-card">
            <h2>Deduplicacion</h2>
            <p>Detecta y elimina letras duplicadas por hash de contenido.</p>
            <div class="actions">
                <button class="btn-secondary" onclick="verDuplicados()">Ver duplicados</button>
                <button class="btn-primary" onclick="deduplicar()">Eliminar duplicados</button>
            </div>
            <div class="result-box" id="resDedup">Listo</div>
        </div>

        <!-- LIMPIAR TEXTOS -->
        <div class="admin-card">
            <h2>Limpieza de Textos</h2>
            <p>Elimina cabeceras, firmas, publicidad y normaliza formato de todas las letras.</p>
            <div class="actions">
                <button class="btn-primary" onclick="limpiarTextos()">Limpiar Todo</button>
            </div>
            <div class="result-box" id="resLimpiar">Listo</div>
        </div>

        <!-- DATASET IA -->
        <div class="admin-card">
            <h2>Dataset IA</h2>
            <p>Genera dataset limpio para entrenar modelos de IA.</p>
            <div class="actions">
                <select id="dsFormato">
                    <option value="simple">Simple (texto)</option>
                    <option value="instruction">Instruction-tuning</option>
                </select>
                <select id="dsModalidad">
                    <option value="">Todas</option>
                    <option value="Comparsa">Comparsa</option>
                    <option value="Chirigota">Chirigota</option>
                    <option value="Coro">Coro</option>
                    <option value="Cuarteto">Cuarteto</option>
                </select>
                <input type="text" id="dsAño" placeholder="A&ntilde;o" style="width:80px">
                <button class="btn-primary" onclick="generarDataset()">Generar</button>
            </div>
            <div class="result-box" id="resDataset">Listo</div>
        </div>

        <!-- CROSS-REFERENCE -->
        <div class="admin-card">
            <h2>Cross-Reference Fuentes</h2>
            <p>Analiza letras compartidas y exclusivas entre las diferentes fuentes de datos.</p>
            <div class="actions">
                <button class="btn-primary" onclick="crossReference()">Analizar</button>
            </div>
            <div class="result-box" id="resCrossRef">Listo</div>
        </div>

        <!-- EXPORTAR -->
        <div class="admin-card">
            <h2>Exportar Version Estatica</h2>
            <p>Exporta toda la base de datos como JSON estructurado por a&ntilde;o y modalidad + frontend navegable.</p>
            <div class="actions">
                <button class="btn-primary" onclick="exportar()">Exportar</button>
            </div>
            <div class="result-box" id="resExport">Listo</div>
        </div>

        <!-- ANÁLISIS POÉTICO -->
        <div class="admin-card" style="border-color:var(--gold)">
            <h2 style="color:var(--gold)">&#9997; An&aacute;lisis Po&eacute;tico del Corpus</h2>
            <p>Analiza m&eacute;trica, rima y figuras ret&oacute;ricas de todas las letras del archivo. El an&aacute;lisis se guarda en la base de datos. Las letras ya analizadas no se repiten salvo que marques "forzar".</p>
            <div class="actions">
                <label style="font-size:0.8rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.3rem;">
                    <input type="checkbox" id="forzarAnalisis"> Forzar re-an&aacute;lisis
                </label>
                <button class="btn-primary" onclick="analizarCorpusAdmin()" style="background:var(--gold);color:#000">Analizar corpus completo</button>
            </div>
            <div class="result-box" id="resPoesia" id="resPoesia">Listo</div>
            <div id="poeticaStatsAdmin" style="margin-top:0.8rem;display:none">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.4rem;font-size:0.8rem;text-align:center;">
                    <div class="admin-stat"><span class="val" id="pAdm_total" style="color:var(--gold)">--</span><span class="lbl">Analizadas</span></div>
                    <div class="admin-stat"><span class="val" id="pAdm_score" style="color:var(--gold)">--</span><span class="lbl">Score medio</span></div>
                    <div class="admin-stat"><span class="val" id="pAdm_metro" style="color:var(--gold)">--</span><span class="lbl">Metro + frecuente</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cargar stats al inicio
fetch("/api/estadisticas").then(r=>r.json()).then(s=>{
    document.getElementById("aTotal").textContent = s.total_letras.toLocaleString("es-ES");
    document.getElementById("aVerificadas").textContent = s.verificadas;
    document.getElementById("aCalidad").textContent = s.calidad_media + "/100";
    document.getElementById("aAños").textContent = s.total_anios;
    document.getElementById("aModalidades").textContent = s.total_modalidades;
});

// Cargar stats por fuente
fetch("/api/estadisticas_fuentes").then(r=>r.json()).then(d=>{
    const container = document.getElementById("fuentesStats");
    if(!d.fuentes || d.fuentes.length===0){
        container.innerHTML='<div class="admin-stat"><span class="val">0</span><span class="lbl">Sin datos</span></div>';
        return;
    }
    const colors = {"letrasdesdeelparaiso":"var(--accent)","letrasdecarnaval":"var(--gold)","huggingface":"var(--success)"};
    container.innerHTML = d.fuentes.map(f=>`
        <div class="admin-stat">
            <span class="val" style="color:${colors[f.fuente]||'var(--accent)'}">${f.total.toLocaleString("es-ES")}</span>
            <span class="lbl">${f.fuente}</span>
            <span style="font-size:0.65rem;color:var(--text-muted)">${f.agrupaciones} agrup. | ${f.anios} a&ntilde;os</span>
        </div>
    `).join("");
});

function setResult(id, text, type) {
    const el = document.getElementById(id);
    el.textContent = text;
    el.className = "result-box" + (type ? " " + type : "");
}

function ejecutarScraper() {
    setResult("resScraper", "Ejecutando scraper...", "working");
    const max = document.getElementById("maxPaginas").value;
    const body = max ? {max_paginas: parseInt(max)} : {};
    fetch("/api/scraper", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)})
    .then(r=>r.json())
    .then(d=>{
        setResult("resScraper",
            `Nuevas: ${d.nuevas}\nDuplicadas: ${d.duplicadas}\nErrores: ${d.errores}\nPaginas: ${d.paginas}`, "success");
        recargarFuentes();
    }).catch(e => setResult("resScraper", "Error: " + e.message));
}

let ldcEventSource = null;

function ldcIniciar() {
    fetch("/api/scraper_letrasdecarnaval/iniciar", {method:"POST"})
    .then(r=>r.json())
    .then(d=>{
        if(!d.ok){ setResult("resScraperLDC", d.mensaje, "working"); return; }
        // Mostrar UI de progreso
        document.getElementById("btnLdcIniciar").style.display="none";
        document.getElementById("btnLdcDetener").style.display="inline-block";
        document.getElementById("ldcProgress").style.display="block";
        setResult("resScraperLDC", "Iniciando...", "working");
        // Conectar SSE
        ldcConectarSSE();
    }).catch(e => setResult("resScraperLDC", "Error: " + e.message));
}

function ldcDetener() {
    fetch("/api/scraper_letrasdecarnaval/detener", {method:"POST"})
    .then(r=>r.json())
    .then(d=>{ setResult("resScraperLDC", d.mensaje, "working"); })
    .catch(e => setResult("resScraperLDC", "Error: " + e.message));
}

function ldcConectarSSE() {
    if(ldcEventSource) ldcEventSource.close();
    ldcEventSource = new EventSource("/api/scraper_letrasdecarnaval/progreso");

    ldcEventSource.onmessage = function(e) {
        const d = JSON.parse(e.data);
        // Actualizar barra
        document.getElementById("ldcBar").style.width = d.porcentaje + "%";
        document.getElementById("ldcPct").textContent = d.porcentaje + "%";
        // Actualizar contadores
        document.getElementById("ldcNuevas").textContent = d.nuevas;
        document.getElementById("ldcDup").textContent = d.duplicadas;
        document.getElementById("ldcErr").textContent = d.errores;
        // Mensaje
        let msg = d.mensaje;
        if(d.ultima_letra) msg += "\n" + d.ultima_letra;
        setResult("resScraperLDC", msg, d.running ? "working" : "success");

        if(d.terminado || !d.running) {
            ldcEventSource.close();
            ldcEventSource = null;
            document.getElementById("btnLdcIniciar").style.display="inline-block";
            document.getElementById("btnLdcDetener").style.display="none";
            recargarFuentes();
        }
    };

    ldcEventSource.onerror = function() {
        ldcEventSource.close();
        ldcEventSource = null;
        document.getElementById("btnLdcIniciar").style.display="inline-block";
        document.getElementById("btnLdcDetener").style.display="none";
    };
}

function ejecutarHuggingFace() {
    setResult("resHuggingFace", "Descargando dataset desde HuggingFace...", "working");
    const soloAccurate = document.getElementById("hfSoloAccurate").checked;
    fetch("/api/importar_huggingface", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({solo_accurate: soloAccurate})})
    .then(r=>r.json())
    .then(d=>{
        setResult("resHuggingFace",
            `Nuevas: ${d.nuevas}\nDuplicadas: ${d.duplicadas}\nErrores: ${d.errores}\nDescargados: ${d.total_descargados}\nConjuntos: ${d.conjuntos.join(", ")}`, "success");
        recargarFuentes();
    }).catch(e => setResult("resHuggingFace", "Error: " + e.message));
}

function recargarFuentes() {
    fetch("/api/estadisticas_fuentes").then(r=>r.json()).then(d=>{
        const container = document.getElementById("fuentesStats");
        const colors = {"letrasdesdeelparaiso":"var(--accent)","letrasdecarnaval":"var(--gold)","huggingface":"var(--success)"};
        container.innerHTML = d.fuentes.map(f=>`
            <div class="admin-stat">
                <span class="val" style="color:${colors[f.fuente]||'var(--accent)'}">${f.total.toLocaleString("es-ES")}</span>
                <span class="lbl">${f.fuente}</span>
                <span style="font-size:0.65rem;color:var(--text-muted)">${f.agrupaciones} agrup. | ${f.anios} a&ntilde;os</span>
            </div>
        `).join("");
    });
    fetch("/api/estadisticas").then(r=>r.json()).then(s=>{
        document.getElementById("aTotal").textContent = s.total_letras.toLocaleString("es-ES");
    });
}

function enriquecer() {
    setResult("resEnriquecer", "Enriqueciendo metadata...", "working");
    fetch("/api/enriquecer", {method:"POST"})
    .then(r=>r.json())
    .then(d=>{
        setResult("resEnriquecer", `Actualizados: ${d.actualizados}\nTextos limpiados: ${d.limpiados}`, "success");
    }).catch(e => setResult("resEnriquecer", "Error: " + e.message));
}

function verDuplicados() {
    setResult("resDedup", "Analizando...", "working");
    fetch("/api/duplicados")
    .then(r=>r.json())
    .then(d=>{
        setResult("resDedup", `Grupos duplicados: ${d.total_grupos}`, "success");
    }).catch(e => setResult("resDedup", "Error: " + e.message));
}

function deduplicar() {
    setResult("resDedup", "Eliminando duplicados...", "working");
    fetch("/api/deduplicar", {method:"POST"})
    .then(r=>r.json())
    .then(d=>{
        setResult("resDedup", `Eliminados: ${d.eliminados}`, "success");
    }).catch(e => setResult("resDedup", "Error: " + e.message));
}

function limpiarTextos() {
    setResult("resLimpiar", "Limpiando textos...", "working");
    fetch("/api/limpiar_textos", {method:"POST"})
    .then(r=>r.json())
    .then(d=>{
        setResult("resLimpiar", `Limpiados: ${d.limpiados} de ${d.total}`, "success");
    }).catch(e => setResult("resLimpiar", "Error: " + e.message));
}

function generarDataset() {
    setResult("resDataset", "Generando dataset...", "working");
    fetch("/api/generar_dataset", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
            formato: document.getElementById("dsFormato").value,
            modalidad: document.getElementById("dsModalidad").value,
            año: document.getElementById("dsAño").value
        })
    })
    .then(r=>r.json())
    .then(d=>{
        setResult("resDataset", `Registros: ${d.registros}\nFormato: ${d.formato}\nArchivo: ${d.archivo}`, "success");
    }).catch(e => setResult("resDataset", "Error: " + e.message));
}

function crossReference() {
    setResult("resCrossRef", "Analizando cruces entre fuentes...", "working");
    fetch("/api/cross_reference")
    .then(r=>r.json())
    .then(d=>{
        let msg = `Letras compartidas entre fuentes: ${d.compartidas_entre_fuentes}`;
        msg += `\nTotal copias cruzadas: ${d.total_cruces}`;
        if(d.exclusivas_por_fuente) {
            msg += `\n\nExclusivas por fuente:`;
            for(const [fuente, count] of Object.entries(d.exclusivas_por_fuente)) {
                msg += `\n  ${fuente}: ${count.toLocaleString("es-ES")}`;
            }
        }
        setResult("resCrossRef", msg, "success");
    }).catch(e => setResult("resCrossRef", "Error: " + e.message));
}

function exportar() {
    setResult("resExport", "Exportando...", "working");
    fetch("/api/export_static", {method:"POST"})
    .then(r=>r.json())
    .then(d=>{
        setResult("resExport",
            `Exportadas: ${d.exportadas}\nArchivos por año: ${d.archivos_año}\nArchivos por modalidad: ${d.archivos_modalidad}\nCarpeta: ${d.carpeta}`, "success");
    }).catch(e => setResult("resExport", "Error: " + e.message));
}

function analizarCorpusAdmin() {
    const forzar = document.getElementById("forzarAnalisis").checked;
    setResult("resPoesia", "Analizando corpus... esto puede tardar varios minutos según el tamaño del archivo.", "working");

    fetch("/api/analizar_todo", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({forzar: forzar})
    })
    .then(r => r.json())
    .then(d => {
        setResult("resPoesia",
            `Analizadas: ${d.analizadas}\nErrores: ${d.errores}\nTotal procesadas: ${d.total_procesadas}`,
            "success"
        );
        // Cargar y mostrar stats poéticas del corpus
        fetch("/api/estadisticas_poeticas")
            .then(r => r.json())
            .then(s => {
                if (s.total_analizadas > 0) {
                    document.getElementById("poeticaStatsAdmin").style.display = "block";
                    document.getElementById("pAdm_total").textContent = s.total_analizadas.toLocaleString("es-ES");
                    document.getElementById("pAdm_score").textContent = s.score_medio + "/100";
                    const topMetro = (s.metros_dominantes || [])[0];
                    document.getElementById("pAdm_metro").textContent = topMetro ? topMetro.metro : "—";
                }
            });
    })
    .catch(e => setResult("resPoesia", "Error: " + e.message));
}

// Cargar stats poéticas al inicio si hay datos
fetch("/api/estadisticas_poeticas")
    .then(r => r.json())
    .then(s => {
        if (s.total_analizadas > 0) {
            document.getElementById("poeticaStatsAdmin").style.display = "block";
            document.getElementById("pAdm_total").textContent = s.total_analizadas.toLocaleString("es-ES");
            document.getElementById("pAdm_score").textContent = s.score_medio + "/100";
            const topMetro = (s.metros_dominantes || [])[0];
            document.getElementById("pAdm_metro").textContent = topMetro ? topMetro.metro : "—";
        }
    });
</script>
</body>
</html>
